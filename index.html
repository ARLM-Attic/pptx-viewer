<!DOCTYPE html>
<html>
  <head>
    <title>PPTX Slide Viewer</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="css/inspector.css">
    <link rel="stylesheet" href="css/codemirror.css">
    <link rel="stylesheet" href="css/solarized.css">
    <link rel="stylesheet" href="css/default.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
    <script src="js/Markdown.Converter.js"></script>
    <script src="js/Markdown.Extra.js"></script>
    <script src="js/codemirror.js"></script>
    <script src="js/xml.js"></script>
    <script src="js/active-line.js"></script>
    <script src="js/zip.js"></script>
    <script src="js/vkbeautify.js"></script>
  </head>
  <body>
    <div id="content-wrapper">
      <div id="content">
          <div id="editor">
          <form>
            <textarea id="code" name="code"></textarea>
          </form>
        </div>
        <div id="markdown">
        </div>
      </div>
    </div>

    <script>
      var editor;

      var instructions = "# PPTX Slide Viewer\n\n" +
      "PPTX Slide Viewer is an interactive tool to display the OpenXML content " +
      "of slides within a PPTX file. It will show the contents of the OpenXML " +
      "content and allow selecting tags to get OpenXML spec data on the tags.\n\n" +
      "To get started, drag and drop a PPTX file in to this window."

      var converter = new Markdown.Converter();
      Markdown.Extra.init(converter);

      var entries = {};
      var model = (function() {
        var URL = window.webkitURL || window.mozURL || window.URL;

        return {
          getEntries : function(file, onend) {
            zip.createReader(new zip.BlobReader(file), function(zipReader) {
              zipReader.getEntries(onend);
            }, onerror);
          },
          getEntryFile : function(entry, onend, onprogress) {
            var writer, zipFileEntry;

            function getData() {
              entry.getData(writer, function(content) {
                onend(content);
              }, onprogress);
            }

            writer = new zip.TextWriter();
            getData();
          }
        };
      })();

      $(document).ready(function() {
        if ($('#code').val().length <= 0) {
          for (var i = 0; i < 100; i++) {
            $('#code').val($('#code').val() + '\n');
          }
        }

        editor = CodeMirror.fromTextArea(document.getElementById('code'), {
          mode: 'application/xml',
          styleActiveLine: true,
          lineNumbers: true,
          lineWrapping: true,
          readOnly: true,
          theme: 'solarized dark'
        });

        var current_file = '';
        editor.on('cursorActivity', function(editor) {
          var line = editor.getLine(editor.getCursor(true).line);
          var found = line.match(/<\??\/?([\w:]+).*?>/i);

          if (found && found[1]) {
            var file = 'docs/' + found[1].replace(':', '_') + '.md';
            if (file !== current_file) {
              $.ajax({
                type: 'GET',
                url: file,
                success: function(msg) {
                  current_file = file;
                  loadMarkdown(msg);
                },
                error: function(xhr, ajaxOptions, thrownError) {
                  current_file = '';
                  loadMarkdown('# Unable to load documentation for `<' + found[1] + '>`.');
                }
              });
            }
          } else {
            current_file = '';
            loadMarkdown('# Nothing available for ' + found[1]);
          }
        });

        zip.workerScriptsPath = 'js/';
        var fileArr = [];
        var tableArr = [];

        window.addEventListener('dragover', function(event) {
          if (event.originalEvent) {
            event.event.originalEvent;
          }

          if (!event.dataTransfer) {
            return;
          }

          var b = event.dataTransfer.effectAllowed;
          event.dataTransfer.dropEffect = ('move' === b || 'linkMove' === b) ? 'move' : 'copy';

          event.stopPropagation();
          event.preventDefault();
        }, false);

        window.addEventListener('dragenter', function(event) {
          if (event.preventDefault) {
            event.preventDefault();
          }
          return false;
        }, false);

        window.addEventListener('drop', function(event) {
          var files = event.dataTransfer.files;

          if (files.length == 1) {
            var entry = event.dataTransfer.items[0].webkitGetAsEntry();
            var file = files[0];
            var is_pptx = file.name.match(/\.pptx/);

            if (entry.isFile && is_pptx) {
              unzip(file);
            } else {
              alert('Not a .pptx file!');
            }

            event.stopPropagation();
            event.preventDefault();
          }
        }, false);

        loadMarkdown(instructions);
      });

      function loadMarkdown(content) {
        var html = converter.makeHtml(content);
        document.getElementById('markdown').innerHTML = html;
      }

      function loadSlide(entry) {
        model.getEntryFile(entry, function(content) {
          editor.setValue(vkbeautify.xml(content, 2));
          $('#openModal').hide();
        }, function(current, total) {
        });
      }

      function unzip(zip) {
        var files = [];

        model.getEntries(zip, function(entries) {
          var markdown = instructions + "\n\n" +
          "Select a slide from the list below:\n";

          entries.forEach(function(entry) {
            if (entry.filename.match(/^ppt\/slides\/\w+\.xml$/i)) {
              files.push(entry.filename);
              entries[entry.filename] = entry;
            }
          });

          files.sort();

          for (i = 0; i < files.length; i++) {
            markdown+= "\n" +
            "> **<a href='#' data-xml='" + files[i] + "'>" + files[i] + "</a>**\n";
          }

          loadMarkdown(markdown);
          $('a[data-xml]').click(function(event) {
              loadSlide(entries[($(this).data('xml'))]);
              event.preventDefault();
          });
        });
      }
    </script>
  </body>
</html>

